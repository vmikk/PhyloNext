/*
========================================================================================
    Nextflow config file for running minimal tests
========================================================================================
    Defines input files and everything required to run a fast and simple pipeline test.

    Use as follows:
        nextflow run vmikk/biodiverse-scripts -r main -profile test

----------------------------------------------------------------------------------------
*/


// Input data
params.input  = "${projectDir}/test_data/test_config/"

// Test profile parameters
params.class = "Mammalia"
params.family = "Felidae,Canidae"
params.country = "DE,PL,CZ"
params.minyear = 2000
params.dbscan = true
params.dbscanepsilon = 700
params.dbscanminpts = 3
params.phytree = "${projectDir}/test_data/phy_trees/Mammals.nwk"
params.taxgroup = "All_life"
params.indices = "calc_richness,calc_simpson_shannon,calc_endemism_whole,calc_pd,calc_pe,calc_phylo_rpd1,calc_phylo_rpd2,calc_phylo_rpe1,calc_phylo_rpe2,calc_phylo_mpd_mntd2"
params.randname = "rand_structured"
params.iterations = 20
params.outdir = "${launchDir}"


// // Limit resources
// executor {
// 
//   $local {
//     cpus = 1
//     // max_memory = '1.GB'
//     // max_time   = '1.h'
//   }
// 
// }


// Process params
process {

    // Use just a single CPU for all processes (does not work)
    // cpus = 1

    withLabel: 'container_r' {
        container = 'vmikk/rarrow:0.0.1'
    }

    withLabel: 'container_biodiverse' {
        container = 'vmikk/biodiverse:0.0.1'
    }

    // Occurrence filtering, stage I
    withName:occ_filter{
        cpus = 1
    }

    // Outlier filtering, stage II - without DBSCAN, all low abundant species
    withName:outl_low{
        cpus = 1
    }

    // Outlier filtering, stage II - with DBSCAN, independently by species
    withName:outl_high{
        cpus = 1
    }

    // Merge filtered species occurrences and prep data for Biodiverse
    withName:merge_occ{
        cpus = 1
    }

    // Create Biodiverse input files
    withName:prep_biodiv {
        cpus = 1
    }

    // Estimate phylogenetic diversity with Biodiverse
    withName:prep_biodiv {
        cpus = 1
    }

    // Export Biodiverse results into CSV
    withName:div_to_csv {
        cpus = 1
    }

}

