/*
================================================================================
    Nextflow config file for running minimal tests
================================================================================
    Defines input files and everything required to run a fast and simple pipeline test.

    Use as follows:
        nextflow run vmikk/phylonext -r main -profile test

--------------------------------------------------------------------------------
*/


// Input data
params.input  = "${projectDir}/test_data/test_config/"

// Test profile parameters
params.class = "Mammalia"
params.family = "Felidae,Canidae"
params.country = "DE,PL,CZ"
params.minyear = 2000
params.wgsrpd = null
params.regions = "NA"
params.dbscan = true
params.dbscanepsilon = 700
params.dbscanminpts = 3
params.phytree = "${projectDir}/test_data/phy_trees/Mammals.nwk"
params.phylabels = "OTT"
params.taxgroup = "Mammals"
params.indices = "calc_richness,calc_simpson_shannon,calc_endemism_whole,calc_pd,calc_pe"
params.randname = "rand_structured"
params.iterations = 20
params.biodiversethreads = 1
params.outdir = "${launchDir}"


// // Limit resources
// executor {
// 
//   $local {
//     cpus = 1
//     // max_memory = '1.GB'
//     // max_time   = '1.h'
//   }
// 
// }


// Process params
process {

    // Use just a single CPU for all processes (does not work)
    // cpus = 1

    // Occurrence filtering, stage I
    withName:occ_filter{
        cpus = 1
    }

    // Outlier filtering, stage II - without DBSCAN, all low abundant species
    withName:outl_low{
        cpus = 1
    }

    // Outlier filtering, stage II - with DBSCAN, independently by species
    withName:outl_high{
        cpus = 1
    }

    // Merge filtered species occurrences and prep data for Biodiverse
    withName:merge_occ{
        cpus = 1
    }

    // Create Biodiverse input files
    withName:prep_biodiv {
        cpus = 1
    }

    // Estimate phylogenetic diversity with Biodiverse
    withName:prep_biodiv {
        cpus = 1
    }

    // Perform Biodiverse randomizations
    withName:phylodiv {
        cpus = 1
    }

    // Prepare a file with paths of `phylodiv` output
    withName:rand_filelist {
        cpus = 1
    }

    // Aggregate randomization results
    withName:aggregate_rnds_biodiv {
        cpus = 1
    }

    // Export Biodiverse results into CSV
    withName:div_to_csv {
        cpus = 1
    }

    // Plot PD indices (non-interactive maps)
    withName:plot_pd {
        cpus = 1
    }

    // Plot PD indices (interactive map - Leaflet-based choropleth)
    withName:plot_leaflet {
        cpus = 1
    }
}

